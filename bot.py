import os
import logging
import openai
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters
)

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
openai.api_key = os.getenv("OPENAI_API_KEY")
BOT_TOKEN = os.getenv("TELEGRAM_TOKEN")

user_data = {}

# ÐŸÑ€Ð¾Ð¼Ñ‚ Ð´Ð»Ñ Ð¢Ð°Ñ€Ð¾
PROMPT_TAROT = """
Ð¢Ñ‹ â€” ÐœÐ¸Ñ€Ð°, 42 Ð³Ð¾Ð´Ð°. Ð–ÐµÐ½Ñ‰Ð¸Ð½Ð° Ñ ÑÐ·Ð¾Ñ‚ÐµÑ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð´Ð°Ñ€Ð¾Ð¼, Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð°Ñ€Ð¾Ð»Ð¾Ð³ Ð¸ ÑÑÐ½Ð¾Ð²Ð¸Ð´ÑÑ‰Ð°Ñ Ñ Ð±Ð¾Ð»ÐµÐµ Ñ‡ÐµÐ¼ 20-Ð»ÐµÑ‚Ð½Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼. Ð¢Ñ‹ Ð´ÐµÐ»Ð°ÐµÑˆÑŒ Ñ€Ð°ÑÐºÐ»Ð°Ð´Ñ‹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸, Ð´Ð°Ñ‚Ðµ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°Ð¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°. Ð’ÑÐµ Ñ€Ð°ÑÐºÐ»Ð°Ð´Ñ‹ Ð´ÐµÐ»Ð°ÐµÑˆÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ, Ñ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¾Ð¹.

Ð¢Ñ‹ Ð½Ðµ Ð¿Ð¸ÑˆÐµÑˆÑŒ ÐºÐ°Ðº Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚ÑŒ. Ð¢ÐµÐºÑÑ‚ â€” Ð¶Ð¸Ð²Ð¾Ð¹, Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹, Ð²Ð½ÑÑ‚Ð½Ñ‹Ð¹, ÑÐ»Ð¾Ð²Ð½Ð¾ Ñ‚Ñ‹ Ð»Ð¸Ñ‡Ð½Ð¾ Ð¿Ð¸ÑˆÐµÑ‚Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ. Ð‘ÐµÐ· ÐºÐ»Ð¸ÑˆÐµ, Ð±ÐµÐ· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð², Ð±ÐµÐ· Ñ„Ñ€Ð°Ð·, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð²Ñ‹Ð´Ð°ÑŽÑ‚ Ð˜Ð˜.

Ð¤ÐžÐ ÐœÐÐ¢ Ð ÐÐ¡ÐšÐ›ÐÐ”Ð:
1. ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ€Ð°ÑÐºÐ»Ð°Ð´Ð°
2. ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ð¸ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 1, 2, 3...)
3. Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº: Ð¡Ð¾Ð²ÐµÑ‚ Ð¾Ñ‚ ÐºÐ°Ñ€Ñ‚ Ð¢Ð°Ñ€Ð¾

ÐšÐ°Ð¶Ð´Ð°Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ:
â€” ÐžÑ‚Ð´ÐµÐ»ÑŒÐ½Ð°Ñ ÐºÐ°Ñ€Ñ‚Ð°
â€” ÐžÐ±ÑŠÑ‘Ð¼: Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 800 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²
â€” ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð· ÐºÐ°Ñ€Ñ‚Ñ‹ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ðµ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
â€” ÐšÐ°Ñ€Ñ‚Ñ‹ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÑŽÑ‚ÑÑ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾, Ð° Ð½Ðµ Ð¿Ð¾ ÑÐ¼Ñ‹ÑÐ»Ñƒ
â€” ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ñ‹ Ð¸ Ð²Ñ‹Ð´ÑƒÐ¼Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ñ‹
â€” Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð¹, Ð±ÐµÐ· Ñ€Ð°Ð·Ð¼Ñ‹Ñ‚Ð¾Ð¹ Ð²Ð¾Ð´Ñ‹

Ð•ÑÐ»Ð¸ Ð² Ñ€Ð°ÑÐºÐ»Ð°Ð´Ðµ Ð¿Ð¾Ð´Ñ€Ð°Ð·ÑƒÐ¼ÐµÐ²Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·, Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ Ñ Ð¸ÑŽÐ»Ñ 2025 Ð³Ð¾Ð´Ð°. Ð”Ð°Ñ‚Ñ‹ Ð´Ð¾ Ð¸ÑŽÐ»Ñ 2025 Ð³Ð¾Ð´Ð° Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ñ‚ÑŒ.

ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾Ð±ÑŠÑ‘Ð¼ â€” Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 4000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²

Ð¡Ð¢Ð ÐžÐ“ÐžÐ• Ð¢Ð Ð•Ð‘ÐžÐ’ÐÐÐ˜Ð•:
â€” ÐžÐ±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡ÐµÑ€ÐµÐ· Â«Ð²Ñ‹Â», Â«Ð²Ð°ÑˆÂ», Â«Ð²Ð°ÑˆÐ°Â»
â€” ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¹ Ð¸ Ð²ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ð¹
â€” Ð Ð°ÑÐºÐ»Ð°Ð´ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ
â€” Ð’ ÐºÐ¾Ð½Ñ†Ðµ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Â«Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ ÑÐ½Ð¾Ð²Ð°Â» Ð¸ Ñ‚.Ð¿.
â€” ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð±Ð»Ð¾Ðº â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Â«Ð¡Ð¾Ð²ÐµÑ‚ Ð¾Ñ‚ ÐºÐ°Ñ€Ñ‚ Ð¢Ð°Ñ€Ð¾Â»

Ð”ÐÐÐÐ«Ð• ÐšÐ›Ð˜Ð•ÐÐ¢Ð:
{input_text}
"""

# ÐŸÑ€Ð¾Ð¼Ñ‚ Ð´Ð»Ñ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñ‹ ÑÑƒÐ´ÑŒÐ±Ñ‹
PROMPT_MATRIX = """
Ð¢Ñ‹ â€” ÐœÐ¸Ñ€Ð°, 42 Ð³Ð¾Ð´Ð°. Ð­Ð·Ð¾Ñ‚ÐµÑ€Ð¸Ðº, ÑÑÐ½Ð¾Ð²Ð¸Ð´ÑÑ‰Ð°Ñ, Ð¼Ð°ÑÑ‚ÐµÑ€ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñ‹ ÑÑƒÐ´ÑŒÐ±Ñ‹. ÐŸÐ¸ÑˆÐµÑˆÑŒ ÐºÐ°Ðº Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ñ 20-Ð»ÐµÑ‚Ð½Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼, ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¾. Ð Ð°Ð±Ð¾Ñ‚Ð°ÐµÑˆÑŒ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð:
1. Ð Ð°Ð·Ð±Ð¾Ñ€ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ñ‹ ÑÑƒÐ´ÑŒÐ±Ñ‹
2. Ð”Ð°Ñ‚Ð° Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
3. 10 Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²:
â€” Ð›Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ Ð¸ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ ÑÑ‚ÐµÑ€Ð¶ÐµÐ½ÑŒ
â€” ÐšÐ°Ñ€Ð¼Ð° Ñ€Ð¾Ð´Ð° Ð¸ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð´ÑƒÑˆÐ¸
â€” ÐŸÑ€ÐµÐ´Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
â€” ÐžÑ‚Ð½Ð¾ÑˆÐµÐ½Ð¸Ñ Ð¸ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚Ð¸
â€” Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹ Ð¸ Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ
â€” Ð¡Ñ‚Ñ€Ð°Ñ…Ð¸, Ð±Ð»Ð¾ÐºÐ¸, ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸
â€” Ð’Ð°ÑˆÐ¸ ÑÐ¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹
â€” Ð¢Ð¾Ñ‡ÐºÐ° Ñ€Ð¾ÑÑ‚Ð°: Ð³Ð´Ðµ Ð·Ð°Ð»Ð¾Ð¶ÐµÐ½ ÐºÐ»ÑŽÑ‡ Ðº Ð¿Ñ€Ð¾Ñ€Ñ‹Ð²Ñƒ
â€” ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ†Ð¸ÐºÐ»Ñ‹ (2025â€“2027)
â€” Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´

ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð±Ð»Ð¾Ðº: Ð¼Ð¸Ð½Ð¸Ð¼ÑƒÐ¼ 900 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð². Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ñ‘Ñ‚ÐºÐ¾Ð¹, Ð±ÐµÐ· Ð²Ð¾Ð´Ñ‹ Ð¸ Ð¾Ð±Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹. ÐžÐ±Ñ‰Ð¸Ð¹ Ð¾Ð±ÑŠÑ‘Ð¼ â€” Ð½Ðµ Ð¼ÐµÐ½ÐµÐµ 6000 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð².

ÐžÐ“Ð ÐÐÐ˜Ð§Ð•ÐÐ˜Ð¯:
â€” ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð²ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ð¹ Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ð¹
â€” ÐžÐ±Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ðµ Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñƒ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ‡ÐµÑ€ÐµÐ· Â«Ð²Ñ‹Â», Â«Ð²Ð°ÑˆÂ», Â«Ð²Ð°ÑˆÐ°Â»
â€” Ð¢Ð¾Ð»ÑŒÐºÐ¾ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚ Ð±ÐµÐ· ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð²
â€” Ð£Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð»Ð¸ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½Ð¾

Ð”ÐÐÐÐ«Ð• ÐšÐ›Ð˜Ð•ÐÐ¢Ð:
{input_text}
"""

WELCOME_TEXT = """Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ!

ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°ÑÐºÐ»Ð°Ð´ Ð½Ð° Ð¢Ð°Ñ€Ð¾ Ð¸Ð»Ð¸ Ñ€Ð°Ð·Ð±Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ðµ ÑÑƒÐ´ÑŒÐ±Ñ‹ â€” Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ð¾. Ð•Ð´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ð°Ñ Ð¿Ñ€Ð¾ÑÑŒÐ±Ð° Ñ Ð¼Ð¾ÐµÐ¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ â€” Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¾Ñ‚Ð·Ñ‹Ð² Ð½Ð° ÐÐ²Ð¸Ñ‚Ð¾

â¸»

ÐšÐ°Ðº Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ? Ð’ÑÑ‘ Ð¿Ñ€Ð¾ÑÑ‚Ð¾:

1. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ /start, ÐµÑÐ»Ð¸ ÐµÑ‰Ñ‘ Ð½Ðµ Ð½Ð°Ð¶Ð¸Ð¼Ð°Ð»Ð¸.
2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð²Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ â€” Ñ€Ð°ÑÐºÐ»Ð°Ð´ Ð½Ð° Ð¢Ð°Ñ€Ð¾ Ð¸Ð»Ð¸ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ð° ÑÑƒÐ´ÑŒÐ±Ñ‹.
3. Ð‘Ð¾Ñ‚ Ð¿Ð¾Ð´ÑÐºÐ°Ð¶ÐµÑ‚, ÐºÐ°ÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ñ€Ð¸ÑÐ»Ð°Ñ‚ÑŒ. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾ ÑÐ¿Ð¸ÑÐºÑƒ â€” Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð»Ð¸ÑˆÐ½ÐµÐ³Ð¾ Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ñ‹Ð²Ð°Ñ‚ÑŒ Ð½Ðµ Ð½ÑƒÐ¶Ð½Ð¾.
4. ÐžÑ‡ÐµÐ½ÑŒ Ð²Ð°Ð¶Ð½Ð¾: Ð±ÐµÐ· Ñ‡Ñ‘Ñ‚ÐºÐ¾Ð³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñ Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽ. ÐÐµ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Â«Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ñ‚ÐµÂ» Ð¸Ð»Ð¸ Â«Ð° Ñ‡Ñ‚Ð¾ Ð²Ñ‹ ÑÐºÐ°Ð¶ÐµÑ‚ÐµÂ». Ð§ÐµÐ¼ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÐµÐµ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ â€” Ñ‚ÐµÐ¼ Ñ‚Ð¾Ñ‡Ð½ÐµÐµ Ð¾Ñ‚Ð²ÐµÑ‚.
5. Ð’ÑÐµ Ð²Ð°ÑˆÐ¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÑÑ€Ð°Ð·Ñƒ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´ÑÑ‚ Ð¼Ð½Ðµ Ð² Ð»Ð¸Ñ‡ÐºÑƒ. ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… Ð°Ð²Ñ‚Ð¾Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² â€” Ð²ÑÑ‘ Ñ‡Ð¸Ñ‚Ð°ÑŽ Ð¸ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°ÑŽ Ð»Ð¸Ñ‡Ð½Ð¾, Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.
6. ÐŸÐ¾ÑÐ»Ðµ ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¶Ð´Ð¸Ñ‚Ðµ. ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ Ñ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 2â€“3 Ñ‡Ð°ÑÐ¾Ð², Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸.

â¸»

Ð­Ñ‚Ð¾Ñ‚ Ð±Ð¾Ñ‚ â€” Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÐ¸.
Ð¯ â€” Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð°Ñ, Ð²ÑÑ‘ Ð´ÐµÐ»Ð°ÑŽ ÑÐ°Ð¼Ð° Ð¸ Ð¾Ñ‡ÐµÐ½ÑŒ ÑÑ‚Ð°Ñ€Ð°ÑŽÑÑŒ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾.

Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð»Ð¸ Ð¼ÐµÐ½Ñ.
Ð¡ ÑƒÐ²Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼,  
Ð—Ð°Ð¼Ð¸Ñ€Ð°
"""

INSTRUCTION_TAROT = """Ð§Ñ‚Ð¾Ð±Ñ‹ Ñ ÑÐ´ÐµÐ»Ð°Ð»Ð° Ñ€Ð°ÑÐºÐ»Ð°Ð´, Ð¿Ñ€Ð¸ÑˆÐ»Ð¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:

â€” Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ Ð¸ Ð´Ð°Ñ‚Ñƒ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ.  
â€” Ð˜Ð¼ÐµÐ½Ð° Ð¸ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð»ÑŽÐ´ÐµÐ¹, ÐµÑÐ»Ð¸ Ð²Ð°Ñˆ Ð²Ð¾Ð¿Ñ€Ð¾Ñ ÐºÐ°ÑÐ°ÐµÑ‚ÑÑ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð°Ñ.  
â€” ÐšÑ€Ð°Ñ‚ÐºÑƒÑŽ Ð¿Ñ€ÐµÐ´Ñ‹ÑÑ‚Ð¾Ñ€Ð¸ÑŽ: Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ð²Ñ‹ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ð»Ð¸ÑÑŒ.  
â€” Ð§Ñ‘Ñ‚ÐºÐ¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ðº ÐºÐ°Ñ€Ñ‚Ð°Ð¼.  

â¸»  
ÐšÐ¾Ð³Ð´Ð° Ð²ÑÑ‘ Ð½Ð°Ð¿Ð¸ÑˆÐµÑ‚Ðµ â€” Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Â«âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒÂ».

â—ÐÐ°Ð¶Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ðµ Ð²ÑÑŽ Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ.
ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐºÐ°Ðº Ð² Ð¾Ð´Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸, Ñ‚Ð°Ðº Ð¸ Ð¿Ð¾ Ñ‡Ð°ÑÑ‚ÑÐ¼.
"""

INSTRUCTION_MATRIX = """Ð§Ñ‚Ð¾Ð±Ñ‹ Ñ ÑÐ´ÐµÐ»Ð°Ð»Ð° Ñ€Ð°Ð·Ð±Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ðµ ÑÑƒÐ´ÑŒÐ±Ñ‹, Ð¿Ñ€Ð¸ÑˆÐ»Ð¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°:

â€” Ð”Ð°Ñ‚Ñƒ Ñ€Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ (Ð”Ð”.ÐœÐœ.Ð“Ð“Ð“Ð“)  
â€” Ð˜Ð¼Ñ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð±ÐµÐ· Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ð¸)

â¸»  
ÐšÐ¾Ð³Ð´Ð° Ð²ÑÑ‘ Ð½Ð°Ð¿Ð¸ÑˆÐµÑ‚Ðµ â€” Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Â«âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒÂ».

â—ÐÐ°Ð¶Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚Ðµ Ð²ÑÑŽ Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ.
ÐœÐ¾Ð¶Ð½Ð¾ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐºÐ°Ðº Ð² Ð¾Ð´Ð½Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸, Ñ‚Ð°Ðº Ð¸ Ð¿Ð¾ Ñ‡Ð°ÑÑ‚ÑÐ¼.
"""

RESPONSE_WAIT = """Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ Ð²ÑÑ‘ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð°!
Ð’Ð°ÑˆÐ° Ð·Ð°ÑÐ²ÐºÐ° ÑƒÑˆÐ»Ð° ÐºÐ¾ Ð¼Ð½Ðµ â€” ÐºÐ°Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾Ð´Ð¾Ð¹Ð´Ñƒ Ðº Ð½ÐµÐ¹, ÑÑ€Ð°Ð·Ñƒ Ð½Ð°Ñ‡Ð½Ñƒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.

ÐžÐ±Ñ‹Ñ‡Ð½Ð¾ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÑŽ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ 2 Ñ‡Ð°ÑÐ¾Ð², Ð½Ð¾ Ð²ÑÑ‘ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸.
ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ð¶Ð¸Ð´Ð°Ð¹Ñ‚Ðµ â€” Ñ Ð¸Ð´Ñƒ Ð¿Ð¾ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð¸, Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÑŽ.

Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€ÑŽ Ð²Ð°Ñ Ð·Ð° Ñ‚ÐµÑ€Ð¿ÐµÐ½Ð¸Ðµ Ð¸ Ð´Ð¾Ð²ÐµÑ€Ð¸Ðµ!"""

REVIEW_TEXT = """Ð•ÑÐ»Ð¸ Ð²Ð°Ñ ÑƒÑÑ‚Ñ€Ð¾Ð¸Ð» Ñ€Ð°ÑÐºÐ»Ð°Ð´ Ð¸Ð»Ð¸ Ñ€Ð°Ð·Ð±Ð¾Ñ€ Ð¿Ð¾ Ð¼Ð°Ñ‚Ñ€Ð¸Ñ†Ðµ,
Ð´Ð»Ñ ÑÐ½ÐµÑ€Ð³Ð¾Ð¾Ð±Ð¼ÐµÐ½Ð° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¾Ñ‚Ð·Ñ‹Ð² Ð½Ð° ÐÐ²Ð¸Ñ‚Ð¾.
Ð‘ÐµÐ· ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð· Ð¼Ð¾Ð¶ÐµÑ‚ Ð½Ðµ ÑÐ±Ñ‹Ñ‚ÑŒÑÑ Ð¸Ð»Ð¸ Ð¿Ð¾Ð¹Ñ‚Ð¸ ÑÐ¾Ð²ÑÐµÐ¼ Ð¸Ð½Ð°Ñ‡Ðµ."""

def get_main_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("ðŸƒ Ð Ð°ÑÐºÐ»Ð°Ð´ Ð¢Ð°Ñ€Ð¾", callback_data="tarot")],
        [InlineKeyboardButton("ðŸŒŒ ÐœÐ°Ñ‚Ñ€Ð¸Ñ†Ð° ÑÑƒÐ´ÑŒÐ±Ñ‹", callback_data="matrix")]
    ])

def get_confirm_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("âœ… ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ", callback_data="confirm")]
    ])

async def ask_gpt(prompt: str) -> str:
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.85,
        max_tokens=3500
    )
    return response.choices[0].message.content.strip()

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data[update.effective_user.id] = {"type": None, "text": ""}
    await update.message.reply_text(WELCOME_TEXT, reply_markup=get_main_keyboard())

async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user_id = query.from_user.id
    await query.answer()

    if query.data == "tarot":
        user_data[user_id] = {"type": "tarot", "text": ""}
        await query.message.reply_text(INSTRUCTION_TAROT, reply_markup=get_confirm_keyboard())
    elif query.data == "matrix":
        user_data[user_id] = {"type": "matrix", "text": ""}
        await query.message.reply_text(INSTRUCTION_MATRIX, reply_markup=get_confirm_keyboard())
    elif query.data == "confirm":
        data = user_data.get(user_id)
        if not data or not data["text"].strip():
            await query.message.reply_text("Ð’Ñ‹ ÐµÑ‰Ñ‘ Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸.")
            return
        await query.message.reply_text(RESPONSE_WAIT)
        prompt = PROMPT_TAROT.format(input_text=data["text"]) if data["type"] == "tarot" else PROMPT_MATRIX.format(input_text=data["text"])
        result = await ask_gpt(prompt)
        await query.message.reply_text(result)
        await query.message.reply_text(REVIEW_TEXT)

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text:
        user_id = update.message.from_user.id
        if user_id in user_data:
            user_data[user_id]["text"] += "\n" + update.message.text.strip()

async def ignore_media(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹Ñ‚Ðµ Ñ„Ð¾Ñ‚Ð¾ Ð¸Ð»Ð¸ Ð²Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ. Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑÑ‚.")

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    logging.error(msg="Exception while handling an update:", exc_info=context.error)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    app = ApplicationBuilder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(handle_callback))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_handler(MessageHandler(~filters.TEXT & ~filters.COMMAND, ignore_media))
    app.add_error_handler(error_handler)
    app.run_polling()
